CC = @CC@
CFLAGS = @CFLAGS@ @CWFLAG@ -I./include
# -DDEBUG
RANLIB = @RANLIB@
RM = rm -f
STRIP = strip
LIBS =
# -lefence
CPLIB = @CPLIB@
EXT =
SUBMAKE_COMM = cd lib ; $(MAKE)

EXECS = install-memo$(EXT) install-user$(EXT)\
		install-todos$(EXT) pilot-addresses$(EXT)\
		read-ical$(EXT)\
		sync-memodir$(EXT) sync-ical$(EXT)\
		pilot-xfer$(EXT) pilot-file$(EXT) pilot-dedupe$(EXT)\
	    reminders$(EXT) memos$(EXT) addresses$(EXT) read-todos$(EXT)\
		test-connector$(EXT) test-acceptor$(EXT) debugsh$(EXT) dlpsh$(EXT) \
		getrom$(EXT)

PILIBS = libpisock.a

all: submake $(EXECS)

submake lib/libpisock.a:
	$(SUBMAKE_COMM)

libpisock.a: lib/libpisock.a
	$(CPLIB) lib/libpisock.a libpisock.a

install-memo$(EXT): $(PILIBS) install-memo.o
	$(CC) $(CFLAGS) install-memo.o $(PILIBS) -o $@ $(LIBS)

install-todos$(EXT): $(PILIBS) install-todos.o
	$(CC) $(CFLAGS) install-todos.o $(PILIBS) -o $@ $(LIBS)

pilot-addresses$(EXT): $(PILIBS) pilot-addresses.o
	$(CC) $(CFLAGS) pilot-addresses.o $(PILIBS) -o $@ $(LIBS)

pilot-dedupe$(EXT): $(PILIBS) pilot-dedupe.o
	$(CC) $(CFLAGS) pilot-dedupe.o $(PILIBS) -o $@ $(LIBS)

install-user$(EXT): $(PILIBS) install-user.o
	$(CC) $(CFLAGS) install-user.o $(PILIBS) -o $@ $(LIBS)

pilot-xfer$(EXT): $(PILIBS) pilot-xfer.o
	$(CC) $(CFLAGS) pilot-xfer.o $(PILIBS) -o $@ $(LIBS)

pilot-file$(EXT): $(PILIBS) pilot-file.o
	$(CC) $(CFLAGS) pilot-file.o $(PILIBS) -o $@ $(LIBS)

reminders$(EXT): $(PILIBS) reminders.o
	$(CC) $(CFLAGS) reminders.o $(PILIBS) -o $@ $(LIBS)

memos$(EXT): $(PILIBS) memos.o
	$(CC) $(CFLAGS) memos.o $(PILIBS) -o $@ $(LIBS)

read-todos$(EXT): $(PILIBS) read-todos.o
	$(CC) $(CFLAGS) read-todos.o $(PILIBS) -o $@ $(LIBS)

read-ical$(EXT): $(PILIBS) read-ical.o
	$(CC) $(CFLAGS) read-ical.o $(PILIBS) -o $@ $(LIBS)

sync-memodir$(EXT): $(PILIBS) sync-memodir.o
	$(CC) $(CFLAGS) sync-memodir.o $(PILIBS) -o $@ $(LIBS)

sync-ical$(EXT): $(PILIBS) sync-ical.o
	$(CC) $(CFLAGS) sync-ical.o $(PILIBS) -o $@ $(LIBS)

addresses$(EXT): $(PILIBS) addresses.o
	$(CC) $(CFLAGS) addresses.o $(PILIBS) -o $@ $(LIBS)

test-connector$(EXT): $(PILIBS) test-connector.o
	$(CC) $(CFLAGS) test-connector.o $(PILIBS) -o $@ $(LIBS)

test-acceptor$(EXT): $(PILIBS) test-acceptor.o
	$(CC) $(CFLAGS) test-acceptor.o $(PILIBS) -o $@ $(LIBS)

dlpsh$(EXT): $(PILIBS) dlpsh.o
	$(CC) $(CFLAGS) dlpsh.o $(PILIBS) -o $@ $(LIBS)

debugsh$(EXT): $(PILIBS) debugsh.o
	$(CC) $(CFLAGS) debugsh.o $(PILIBS) -o $@ $(LIBS)

getrom$(EXT): $(PILIBS) getrom.o
	$(CC) $(CFLAGS) getrom.o $(PILIBS) -o $@ $(LIBS)
	
strip: $(EXECS)
	$(STRIP) $(EXECS)

distclean: clean
	$(SUBMAKE_COMM) depend
	$(RM) Makefile lib/Makefile lib/Makefile.in~ include/pi-config.h
	$(RM) config.log config.status config.cache
	$(RM) PiDebug.log
	perl os2dist.pl

clean:
	$(RM) *.o *.a *~ core a.out test_s test_c install-prc$(EXT) 
	$(RM) $(EXECS)
	$(RM) include/*~ man/*~ *.orig include/*.orig
	$(RM) pilot.rom
	$(SUBMAKE_COMM) clean
